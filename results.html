<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overall Results - Mask Tasker</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>ðŸŽ­ Mask Tasker</h1>
            <p>The Ultimate Monthly Challenge Game</p>
        </div>
    </header>

    <nav id="main-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="results.html" class="active">Results</a></li>
        </ul>
    </nav>

    <main>
        <div class="container">
            <div class="results-table">
                <h2>Overall Results</h2>
                <div id="results-content">
                    <div class="loading">Calculating results</div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Mask Tasker. All rights reserved.</p>
    </footer>

    <script src="js/main.js"></script>
    <script>
        loadResults();

        async function loadResults() {
            try {
                const config = await loadConfig();
                updateNavigation(config);

                // Collect all scores from all months
                const teamScores = {};

                for (const month of config.months) {
                    try {
                        const response = await fetch(`data/months/month${month.id}.json`);
                        if (!response.ok) continue;

                        const monthData = await response.json();

                        monthData.submissions.forEach(submission => {
                            if (!teamScores[submission.teamName]) {
                                teamScores[submission.teamName] = {
                                    total: 0,
                                    months: {}
                                };
                            }
                            teamScores[submission.teamName].total += submission.score;
                            teamScores[submission.teamName].months[month.id] = submission.score;
                        });
                    } catch (error) {
                        console.warn(`Could not load month ${month.id}:`, error);
                    }
                }

                displayResults(teamScores, config.months);
            } catch (error) {
                document.getElementById('results-content').innerHTML =
                    '<p style="text-align: center; color: red;">Error loading results. Please check the console.</p>';
                console.error('Error:', error);
            }
        }

        function updateNavigation(config) {
            const navList = document.querySelector('#main-nav ul');

            // Add month links to navigation
            config.months.forEach(month => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `month.html?id=${month.id}`;
                a.textContent = month.title;
                li.appendChild(a);
                navList.appendChild(li);
            });
        }

        function displayResults(teamScores, months) {
            // Sort teams by total score
            const sortedTeams = Object.entries(teamScores).sort((a, b) => b[1].total - a[1].total);

            if (sortedTeams.length === 0) {
                document.getElementById('results-content').innerHTML =
                    '<p style="text-align: center;">No results yet. Complete some monthly challenges first!</p>';
                return;
            }

            let tableHTML = '<table><thead><tr><th>Rank</th><th>Team Name</th>';

            // Add month columns
            months.forEach(month => {
                tableHTML += `<th>${month.title}</th>`;
            });

            tableHTML += '<th>Total Score</th></tr></thead><tbody>';

            // Add team rows
            sortedTeams.forEach(([teamName, data], index) => {
                const rank = index + 1;
                let rowClass = '';
                if (rank === 1) rowClass = 'rank-1';
                else if (rank === 2) rowClass = 'rank-2';
                else if (rank === 3) rowClass = 'rank-3';

                tableHTML += `<tr class="${rowClass}"><td>${rank}</td><td>${teamName}</td>`;

                // Add scores for each month
                months.forEach(month => {
                    const score = data.months[month.id] || '-';
                    tableHTML += `<td>${score}</td>`;
                });

                tableHTML += `<td class="total-score">${data.total}</td></tr>`;
            });

            tableHTML += '</tbody></table>';

            document.getElementById('results-content').innerHTML = tableHTML;
        }
    </script>
</body>
</html>
